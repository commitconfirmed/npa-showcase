{# Underlay Loopback PFL #}
ip prefix-list PL-LOOPBACK
   permit 10.0.0.0/24 eq 32

{# Underlay Loopback RM #}
route-map RM-UNDERLAY permit 10
   match ip address prefix-list PL-LOOPBACK
route-map RM-UNDERLAY deny 20

{# Underlay Peer AS Filter #}
peer-filter PF-UNDERLAY
   match as-range 65100-65200 result accept

{# Underlay BGP Configuration #}
router bgp {{ bgp.local_as }}
   router-id {{ bgp.router_id }}
   no bgp default ipv4-unicast
   maximum-paths 4 ecmp 4
{% if bgp.type == "spine" %}
   bgp listen range fe80::/10 peer-group {{ bgp.underlay_name }} peer-filter PF-UNDERLAY
{% endif %}
{% if bgp.type == "leaf" %}
{%     for item in bgp.underlay_interfaces %}
   neighbor interface {{ item }} peer-group {{ bgp.underlay_name}} remote-as {{ bgp.underlay_as }}
{%     endfor %}
{% endif %}
   neighbor {{ bgp.underlay_name }} peer group
   neighbor {{ bgp.underlay_name }} send-community
   address-family ipv4
      neighbor {{ bgp.underlay_name }} activate
      neighbor {{ bgp.underlay_name }} next-hop address-family ipv6 originate
      redistribute connected route-map RM-LOOPBACK
